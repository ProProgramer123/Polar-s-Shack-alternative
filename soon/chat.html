<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>polar's shack - chat</title>
  <link rel="icon" href="../logo.png" type="image/png">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <link rel="stylesheet" href="tospopup.css">
  <script src="tospopup.js" defer></script>

  <style>
    body {
      font-family: 'JetBrains Mono', monospace;
      background: #111;
      color: #eee;
      margin: 0;
    }
    /* navbar same as before */
    .navbar {background:#1a1a1a;padding:1rem 2rem;position:fixed;top:0;width:100%;z-index:1000;border-bottom:1px solid #333;}
    .nav-container{display:flex;justify-content:space-between;align-items:center;max-width:1200px;margin:0 auto;}
    .logo-nav{display:flex;align-items:center;gap:10px;}
    .logo-nav img{width:32px;height:32px;border-radius:4px;}
    .logo-nav span{font-size:1.2rem;font-weight:500;color:#fff;}
    .nav-links{display:flex;gap:2rem;list-style:none;}
    .nav-links a{color:#888;text-decoration:none;transition:.3s;}
    .nav-links a:hover,.nav-links a.active{color:#00ff00;}

    .main-content{margin-top:90px;max-width:900px;margin-inline:auto;padding:1rem;}

    /* chat card */
    .chat-card {
      background:#1e1e1e;
      border:1px solid #333;
      border-radius:12px;
      display:flex;
      flex-direction:column;
      height:600px;
      box-shadow:0 4px 12px rgba(0,0,0,.4);
      overflow:hidden;
    }
    .chat-header {
      padding:0.8rem 1rem;
      border-bottom:1px solid #333;
      font-weight:600;
      color:#00ff00;
      display:flex;
      justify-content:space-between;
    }
    .chat-messages {
      flex:1;
      overflow-y:auto;
      padding:1rem;
      display:flex;
      flex-direction:column;
      gap:0.5rem;
    }
    .msg {
      max-width:70%;
      padding:0.6rem 0.8rem;
      border-radius:10px;
      font-size:0.95rem;
    }
    .msg.me {background:#00ff0044;align-self:flex-end;}
    .msg.other {background:#333;align-self:flex-start;}
    .chat-input-bar {
      display:flex;
      gap:0.5rem;
      padding:0.8rem;
      border-top:1px solid #333;
      background:#1a1a1a;
    }
    .chat-input-bar input {
      flex:1;
      padding:0.8rem;
      border:none;
      border-radius:8px;
      background:#2a2a2a;
      color:#fff;
    }
    .chat-input-bar button {
      background:#00ff00;
      border:none;
      padding:0 1.5rem;
      font-weight:600;
      border-radius:8px;
      cursor:pointer;
    }
    .chat-input-bar button:hover {background:#00cc00;}

    /* modal login */
    .modal-bg {
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.6);
      display:flex;align-items:center;justify-content:center;
      z-index:2000;
    }
    .modal {
      background:#1e1e1e;
      padding:2rem;
      border-radius:12px;
      width:300px;
      display:flex;
      flex-direction:column;
      gap:0.8rem;
      box-shadow:0 4px 20px rgba(0,0,0,.6);
    }
    .modal h2 {margin:0 0 1rem;font-size:1.2rem;color:#00ff00;}
    .modal input {
      padding:0.7rem;
      border:none;
      border-radius:6px;
      background:#2a2a2a;
      color:#fff;
    }
    .modal button {
      background:#00ff00;
      border:none;
      padding:0.7rem;
      font-weight:600;
      border-radius:6px;
      cursor:pointer;
    }
    .modal button:hover {background:#00cc00;}
    .modal .switch {font-size:0.85rem;color:#aaa;text-align:center;cursor:pointer;}
    .online-count {font-size:0.9rem;color:#aaa;}
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="logo-nav">
        <img src="../logo.png" alt="Logo">
        <span>polar's.shack</span>
      </div>
      <ul class="nav-links">
        <li><a href="index.html">home</a></li>
        <li><a href="osint.html">osint</a></li>
        <li><a href="csint.html">csint</a></li>
        <li><a href="tools.html">tools</a></li>
        <li><a href="games.html">games</a></li>
        <li><a href="apps.html">apps</a></li>
        <li><a href="proxy.html">proxy</a></li>
        <li><a href="chat.html" class="active">chat</a></li>
      </ul>
    </div>
  </nav>

  <main class="main-content">
    <div class="chat-card">
      <div class="chat-header">
        <span>chat room</span>
        <span class="online-count">online: <span id="onlineCount">0</span></span>
      </div>
      <div id="chatMessages" class="chat-messages"></div>
      <div class="chat-input-bar">
        <input id="chatInput" placeholder="type a message..."/>
        <button onclick="sendMessage()">send</button>
      </div>
    </div>
  </main>

  <!-- login modal -->
  <div class="modal-bg" id="authModal">
    <div class="modal">
      <h2 id="authTitle">login</h2>
      <input type="email" id="email" placeholder="email"/>
      <input type="password" id="password" placeholder="password"/>
      <button id="authBtn">login</button>
      <div class="switch" onclick="toggleMode()">no account? sign up</div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "PASTE_REAL_KEY",
      authDomain: "PASTE_REAL_AUTH_DOMAIN",
      projectId: "PASTE_REAL_PROJECT_ID",
      storageBucket: "PASTE_REAL_BUCKET",
      messagingSenderId: "PASTE_REAL_SENDER_ID",
      appId: "PASTE_REAL_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const authModal = document.getElementById('authModal');
    const authTitle = document.getElementById('authTitle');
    const authBtn = document.getElementById('authBtn');
    let mode = "login";

    function toggleMode() {
      mode = mode === "login" ? "signup" : "login";
      authTitle.textContent = mode;
      authBtn.textContent = mode;
      document.querySelector('.switch').textContent =
        mode === "login" ? "no account? sign up" : "already have an account? login";
    }

    authBtn.onclick = () => {
      const email = document.getElementById('email').value;
      const pw = document.getElementById('password').value;
      if (mode === "signup") {
        auth.createUserWithEmailAndPassword(email, pw).catch(alert);
      } else {
        auth.signInWithEmailAndPassword(email, pw).catch(alert);
      }
    };

    auth.onAuthStateChanged(user => {
      if (user) {
        authModal.style.display = "none";
        const userRef = db.collection("online_users").doc(user.uid);
        userRef.set({ email:user.email }, { merge:true });
        window.addEventListener("beforeunload", () => userRef.delete());
      } else {
        authModal.style.display = "flex";
      }
    });

    // track online count
    db.collection("online_users").onSnapshot(snap=>{
      document.getElementById("onlineCount").textContent = snap.size;
    });

    // chat functions
    function sendMessage() {
      const text = document.getElementById('chatInput').value.trim();
      if (!text) return;
      const user = auth.currentUser;
      if (!user) return alert("login first!");
      db.collection("messages").add({
        text,
        uid:user.uid,
        email:user.email,
        createdAt:firebase.firestore.FieldValue.serverTimestamp()
      });
      document.getElementById('chatInput').value = "";
    }

    db.collection("messages").orderBy("createdAt").limit(50).onSnapshot(snap=>{
      const msgBox=document.getElementById('chatMessages');
      msgBox.innerHTML="";
      snap.forEach(doc=>{
        const m=doc.data();
        const div=document.createElement("div");
        div.className="msg "+(auth.currentUser && m.uid===auth.currentUser.uid ? "me":"other");
        div.textContent=m.text;
        msgBox.appendChild(div);
      });
      msgBox.scrollTop=msgBox.scrollHeight;
    });
  </script>
</body>
</html>
