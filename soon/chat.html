<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Polar's Shack — Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="../logo.png">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600&display=swap" rel="stylesheet">

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root {
  --bg:#111;
  --card:#1e1e1e;
  --muted:#666;
  --accent:#00ff00;
  --danger:#ff6666;
  --panel:#0f0f0f;
}
* { box-sizing: border-box }
body {
  margin:0;
  font-family:'JetBrains Mono', monospace;
  background:linear-gradient(180deg,#0b0b0b,var(--bg));
  color:#ddd;
  height:100vh;
  display:flex;
  flex-direction:column;
}

/* NAVBAR */
.navbar {
  background:#1a1a1a;
  padding:1rem 1.25rem;
  border-bottom:1px solid #262626;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;
  z-index:60;
}
.logo-nav {display:flex;gap:.75rem;align-items:center}
.logo-nav img {width:34px;height:34px;border-radius:6px}
.logo-nav span {color:#fff;font-weight:600}
.nav-links {display:flex;gap:1rem;align-items:center}
.nav-links a {color:#aaa;text-decoration:none;padding:.2rem .35rem;border-radius:4px}
.nav-links a.active, .nav-links a:hover {color:var(--accent)}

/* Layout wrapper */
.layout {
  display:flex;
  height:calc(100vh - 60px); /* minus navbar */
  width:100%;
  overflow:hidden;
}

/* Users panel */
.users-panel {
  width:220px;
  background:var(--panel);
  border-right:1px solid #333;
  padding:.75rem;
  overflow-y:auto;
  box-shadow:0 6px 18px rgba(0,0,0,0.5);
}
.users-panel h3 {color:var(--accent);margin:.15rem 0 .75rem;font-size:1rem}
.user-row {display:flex;justify-content:space-between;align-items:center;padding:.45rem .5rem;border-radius:6px;transition:background .12s, transform .08s;cursor:default;}
.user-row:hover {background:#151515;transform:translateY(-1px)}
.user-name {color:#fff;font-weight:600}
.user-meta {font-size:.8rem;color:var(--muted)}
.badge-admin {color:var(--danger);font-weight:700;margin-left:.4rem}

/* Chat card */
.chat-card {
  flex:1;
  display:flex;
  flex-direction:column;
  background:linear-gradient(180deg,#121212,#161616);
  border-left:1px solid #222;
  overflow:hidden;
  box-shadow:0 10px 30px rgba(0,0,0,0.6);
}
.chat-header {padding:.8rem 1rem;border-bottom:1px solid #222;display:flex;justify-content:space-between;align-items:center;gap:1rem;}
.chat-header .title {color:var(--accent);font-weight:700}
.chat-header .right {font-size:.9rem;color:var(--muted);display:flex;gap:.75rem;align-items:center}

/* Logout */
.logout-btn {
  margin-left:1rem;
  padding:.35rem .75rem;
  border:1px solid #333;
  border-radius:6px;
  background:#222;
  color:#eee;
  font-size:.9rem;
  cursor:pointer;
  transition:background .2s;
}
.logout-btn:hover {background:#2c2c2c}

/* Messages */
.messages {
  flex:1;
  padding:1rem;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:.55rem;
  scroll-behavior:smooth;
  background:radial-gradient(1200px 200px at 10% 0%, rgba(0,255,0,0.01), transparent 2%),transparent;
}
.msg {max-width:72%;padding:.6rem .85rem;border-radius:10px;display:inline-block;line-height:1.25;animation:enter .18s ease;box-shadow:0 2px 6px rgba(0,0,0,0.45);}
.msg .meta {display:block;font-size:.78rem;color:var(--muted);margin-bottom:.22rem}
.msg.me {align-self:flex-end;background:var(--accent);color:#050505;border-bottom-right-radius:4px}
.msg.other {align-self:flex-start;background:#171717;color:#ddd;border-bottom-left-radius:4px}
.msg.system {align-self:center;background:transparent;color:#888;font-style:italic;padding:.25rem .5rem;border-radius:6px}
.admin-tag {color:var(--danger);font-weight:700;margin-left:.45rem;font-size:.8rem}
@keyframes enter { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none} }

/* Input */
.input-bar {
  display:flex;
  gap:.6rem;
  padding:.8rem;
  border-top:1px solid #222;
  background:linear-gradient(180deg,#0f0f0f,#131313);
  align-items:center;
}
.input-bar input {
  flex:1;
  padding:14px 16px;
  border-radius:10px;
  border:none;
  background:#1f1f1f;
  color:#fff;
  outline:none;
  font-size:1rem;
}
.send-btn {
  background:var(--accent);
  border:none;
  padding:12px 16px;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
  transition:transform .12s ease, filter .12s;
}
.send-btn:active {transform:scale(.98);filter:brightness(.95)}

/* Modals (ban) */
.ban-modal {position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.75);z-index:120;}
.ban-box {background:#1c1c1c;padding:1.25rem 1.5rem;border-radius:8px;border:1px solid #3a1a1a;max-width:420px;text-align:center;color:#fff;}
.ban-box h3 {color:var(--danger);margin:0 0 .5rem}
.ban-box p {color:#ddd;margin:.5rem 0 1rem;font-size:.95rem}
.ban-box button {background:#444;color:#fff;border:none;padding:.6rem .9rem;border-radius:6px;cursor:pointer}

/* Responsive */
@media (max-width:900px){
  .layout {flex-direction:column}
  .users-panel {order:2;height:160px;display:flex;flex-direction:row;gap:.4rem;overflow-x:auto;width:100%}
  .users-panel .user-row {min-width:120px;flex-direction:column;align-items:flex-start}
  .chat-card {height:calc(100vh - 220px)}
}
  </style>
</head>
<body>
    <nav class="navbar">
    <div class="logo-nav">
      <img src="../logo.png" alt="logo">
      <span>polar's.shack</span>
    </div>
    <div class="nav-links">
  <a href="index.html">home</a>
  <a href="chat.html" class="active">chat</a>
  <a href="tos.html">tos</a>
  <a href="privacy.html">privacy</a>
  <button id="logoutBtn" class="logout-btn">logout</button>
    </div>
  </nav>

  <div class="layout">
    <aside class="users-panel">
      <h3>online users</h3>
      <div id="usersList"></div>
    </aside>

    <section class="chat-card">
      <div class="chat-header">
        <div class="title">Polar's Shack — Chat</div>
        <div class="right">
          <span id="meDisplay">@guest</span>
          <button id="logoutBtn" class="logout-btn" style="display:none">log out</button>
        </div>
      </div>

      <div id="messages" class="messages"></div>

      <div class="input-bar">
        <input id="messageInput" placeholder="Say something — press Enter to send" autocomplete="off" />
        <button class="send-btn" id="sendBtn">send</button>
      </div>
    </section>
  </div>

  <!-- auth modal -->
  <div id="authModal" class="modal" style="display:flex">
    <div class="modal-content" style="background:#161616;padding:20px;border-radius:10px;border:1px solid #222; width:320px;max-width:92vw; margin:auto;">
      <h2 style="color:var(--accent);margin:0 0 12px;text-align:center">Sign in / Sign up</h2>
      <input id="authUsername" placeholder="username" style="width:100%;padding:10px;margin-bottom:8px;border-radius:6px;border:none;background:#222;color:#fff"/>
      <input id="authPassword" type="password" placeholder="password" style="width:100%;padding:10px;margin-bottom:8px;border-radius:6px;border:none;background:#222;color:#fff"/>
      <div style="display:flex;gap:.5rem">
        <button id="signInBtn" style="flex:1;padding:10px;border-radius:6px;border:none;background:var(--accent);cursor:pointer;font-weight:700">Sign In</button>
        <button id="signUpBtn" style="flex:1;padding:10px;border-radius:6px;border:1px solid #2b2b2b;background:#222;color:#fff;cursor:pointer">Sign Up</button>
      </div>
      <p style="color:var(--muted);font-size:.88rem;margin-top:8px;text-align:center">Usernames are unique. Passwords are required.</p>
      <p id="authError" style="color:var(--danger);display:none;margin:8px 0 0;text-align:center"></p>
    </div>
  </div>

  <!-- banned modal -->
  <div id="banModal" class="ban-modal" style="display:none">
    <div class="ban-box">
      <h3>Account Banned</h3>
      <p id="banReason">You have been banned from chat.</p>
      <button onclick="closeBan()">ok</button>
    </div>
  </div>

<!-- Import analytics.js -->
<script src="analytics.js"></script>
<script>
  // Call it once when the page loads
  initAnalytics();
</script>

  <script>
    function escapeHtml(text) {
  if (!text) return '';
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}
        // firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBYyJuTAkVPB_65NqSeca6IueMoMO1iPzs",
      authDomain: "polars-shack.firebaseapp.com",
      projectId: "polars-shack",
      storageBucket: "polars-shack.firebasestorage.app",
      messagingSenderId: "205388124682",
      appId: "1:205388124682:web:2b0b1605517e0c6c53c5f3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    async function isAdmin(uid) {
  if (!uid) return false;
  const snap = await db.collection("admins").doc(uid).get();
  return snap.exists;
}

    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.addEventListener('click', async () => {
      try {
        await auth.signOut();
      } catch (e) { console.error(e); }
    });

        // ---------- state ----------
    let my = { uid: null, username: null, isAdmin: false };
    const messagesEl = document.getElementById('messages');
    const usersListEl = document.getElementById('usersList');
    const meDisplay = document.getElementById('meDisplay');
    const authModal = document.getElementById('authModal');
    const banModal = document.getElementById('banModal');
    const banReasonEl = document.getElementById('banReason');
    const authErrorEl = document.getElementById('authError');

    // helpers
    const sleep = ms => new Promise(r => setTimeout(r, ms));

    // ---------- auth with username+password trick ----------
    // when signing up, we create Firebase Auth user with fake email: username@polars.shack
    // and store username in chat_users/{uid}.  This keeps sign-in with username + password.

    async function signUp(username, password) {
      try {
        authErrorEl.style.display = 'none';
        const fakeEmail = `${username}@polars.shack`;
        const cred = await auth.createUserWithEmailAndPassword(fakeEmail, password);
        const uid = cred.user.uid;
        // write chat_users doc
        await db.collection('chat_users').doc(uid).set({
          username,
          isAdmin: false,
          online: true,
          warnings: 0,
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        });
        my.uid = uid; my.username = username;
        await afterLogin();
      } catch (err) {
        authErrorEl.textContent = err.message; authErrorEl.style.display = 'block';
      }
    }

    async function signIn(username, password) {
      try {
        authErrorEl.style.display = 'none';
        const fakeEmail = `${username}@polars.shack`;
        const cred = await auth.signInWithEmailAndPassword(fakeEmail, password);
        const uid = cred.user.uid;
        // ensure chat_users exists
        const userRef = db.collection('chat_users').doc(uid);
        const doc = await userRef.get();
        if (!doc.exists) {
          // weird state, create record
          await userRef.set({ username, isAdmin:false, online:true, warnings:0, lastSeen: firebase.firestore.FieldValue.serverTimestamp()});
        } else {
          await userRef.update({ online:true, lastSeen: firebase.firestore.FieldValue.serverTimestamp()});
        }
        // check banned
        const bannedDoc = await db.collection('banned_users').doc(uid).get();
        if (bannedDoc.exists) {
          const reason = bannedDoc.data().reason || 'banned';
          // sign out immediately
          await auth.signOut();
          showBan(reason);
          return;
        }

        my.uid = uid;
        my.username = (doc.exists ? doc.data().username : username);
        // refresh admin flag
        my.isAdmin = doc.exists && doc.data().isAdmin === true;

        await afterLogin();
      } catch (err) {
        authErrorEl.textContent = err.message; authErrorEl.style.display = 'block';
      }
    }

    document.getElementById('signUpBtn').addEventListener('click', () => {
      const u = document.getElementById('authUsername').value.trim();
      const p = document.getElementById('authPassword').value;
      if (!u || !p) { authErrorEl.textContent='fill both fields'; authErrorEl.style.display='block'; return; }
      signUp(u.toLowerCase(), p);
    });
    document.getElementById('signInBtn').addEventListener('click', () => {
      const u = document.getElementById('authUsername').value.trim();
      const p = document.getElementById('authPassword').value;
      if (!u || !p) { authErrorEl.textContent='fill both fields'; authErrorEl.style.display='block'; return; }
      signIn(u.toLowerCase(), p);
    });

    // after login actions
    async function afterLogin() {
      authModal.style.display = 'none';
      meDisplay.textContent = `@${my.username}${my.isAdmin? ' [admin]' : ''}`;
      // send join system message
      await db.collection('messages').add({
        username:'system',
        text:`${my.username} joined the chat`,
        system:true,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      subscribeUsers();
      subscribeMessages();
      // keep online status alive
      const myRef = db.collection('chat_users').doc(my.uid);
      window.addEventListener('beforeunload', async () => {
        try{ await myRef.update({ online:false, lastSeen:firebase.firestore.FieldValue.serverTimestamp() }); }
        catch(e){}
      });
      // reactively watch my user doc (for ban/mute/role changes)
      myRef.onSnapshot(doc => {
        if (!doc.exists) return;
        const data = doc.data();
        my.isAdmin = !!data.isAdmin;
        // if banned flag placed inside chat_users (optional), handle
        if (data.banned) {
          showBan(data.banReason || 'banned');
        }
      });
    }

    // ---------- subscribe to users ----------
    function subscribeUsers() {
      db.collection('chat_users').orderBy('username').onSnapshot(snap => {
        usersListEl.innerHTML = '';
        snap.forEach(d => {
          const u = d.data();
          const row = document.createElement('div');
          row.className = 'user-row';
          row.innerHTML = `<div><span class="user-name">@${escapeHtml(u.username)}</span>${u.isAdmin?'<span class="badge-admin">admin</span>':''}</div><div class="user-meta">${u.online?'<span style="color:var(--accent)">online</span>':'<span style="color:var(--muted)">offline</span>'}</div>`;
          usersListEl.appendChild(row);
        });
      });
    }

    // ---------- messages subscription with lazy initial load (last 100) ----------
    let messagesListener = null;
    function subscribeMessages() {
      if (messagesListener) messagesListener(); // detach
      messagesEl.innerHTML = '';
      // listen to last 200 messages ordered ascending
      messagesListener = db.collection('messages').orderBy('timestamp','asc').limitToLast(200)
        .onSnapshot(snapshot => {
          messagesEl.innerHTML = '';
          snapshot.forEach(doc => {
            renderMessage(doc.id, doc.data());
          });
          messagesEl.scrollTop = messagesEl.scrollHeight;
        });
    }

    // ---------- render message ----------
    function renderMessage(id, msg) {
      const wrap = document.createElement('div');
      wrap.dataset.id = id;
      if (msg.system) {
        wrap.className = 'msg system';
        wrap.textContent = msg.text;
      } else {
        const isMe = (msg.username === my.username);
        wrap.className = 'msg ' + (isMe? 'me' : 'other');
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerHTML = `<strong style="color:${isMe? '#050505': 'var(--accent)'}">@${escapeHtml(msg.username)}</strong> ${msg.isAdmin ? '<span class="admin-tag">admin</span>' : ''} <span style="color:var(--muted);font-size:.82rem;margin-left:.5rem">${formatTimestamp(msg.timestamp)}</span>`;
        const content = document.createElement('div');
        content.className = 'content';
        content.style.marginTop = '.18rem';
        content.innerHTML = escapeHtml(msg.text).replace(/\n/g,'<br/>');
        wrap.appendChild(meta);
        wrap.appendChild(content);
      }
      messagesEl.appendChild(wrap);
    }

    // ---------- send message (and command processing) ----------
    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keydown', async (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        await sendMessage();
      }
    });

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (!text) return;

      if (!my.uid) { alert('please sign in'); return; }

      // Banned/muted checks (same as before)...

      // Handle commands
      if (text.startsWith('/')) {
        const parts = text.trim().split(/\s+/);
        const cmd = parts[0].toLowerCase();

        if (cmd === '/modcall') {
          const reason = parts.slice(1).join(' ') || 'no reason provided';
          await db.collection('messages').add({
            username: 'system',
            text: `🚨 MODCALL from @${my.username}: ${reason}`,
            system: true,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
          toast('modcall sent to admins');
          input.value = '';
          return;
        }

        // everything else = admin only
        const isAdminNow = await isAdmin(my.uid);
        if (!isAdminNow) {
          await sendSystem(`${my.username} attempted admin command (no perms)`);
          input.value = '';
          return;
        }
        await handleAdminCommand(text);
        input.value = '';
        return;
      }

      // normal message
      await db.collection('messages').add({
        username: my.username,
        text,
        isAdmin: await isAdmin(my.uid),
        system: false,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      input.value = '';
    }

    // ---------- admin command router ----------
    async function handleAdminCommand(raw) {
      const parts = raw.trim().split(/\s+/);
      const cmd = parts[0].toLowerCase();
      const arg1 = parts[1] || '';
      const argRest = parts.slice(2).join(' ');

      switch (cmd) {
        case '/help':
          await sendSystem('admin commands: /help, /ban, /unban, /kick, /mute, /unmute, /warn, /clear, /giveadmin, /removeadmin, /announce, /listadmins, /whois, /lockchat, /unlockchat, /slowmode <sec>, /topic <msg>, /shadowban <user>, /unshadowban <user>, /purge <user> [n]');
          break;

                case '/ban':
          if (!arg1) { await sendSystem('usage: /ban <username> [reason]'); break; }
          await adminBan(arg1.toLowerCase(), argRest || 'no reason');
          break;

        case '/unban':
          if (!arg1) { await sendSystem('usage: /unban <username>'); break; }
          await adminUnban(arg1.toLowerCase());
          break;

        case '/kick':
          if (!arg1) { await sendSystem('usage: /kick <username>'); break; }
          await adminKick(arg1.toLowerCase());
          break;

        case '/mute':
          if (!arg1 || !parts[2]) { await sendSystem('usage: /mute <username> <minutes>'); break; }
          await adminMute(arg1.toLowerCase(), parseInt(parts[2],10) || 10);
          break;

        case '/unmute':
          if (!arg1) { await sendSystem('usage: /unmute <username>'); break; }
          await adminUnmute(arg1.toLowerCase());
          break;

        case '/warn':
          if (!arg1) { await sendSystem('usage: /warn <username> [note]'); break; }
          await adminWarn(arg1.toLowerCase(), argRest || 'warning from admin');
          break;

        case '/clear':
          // /clear or /clear N
          await adminClear(parts[1] ? parseInt(parts[1],10) : 200);
          break;

        case '/giveadmin':
          if (!arg1) { await sendSystem('usage: /giveadmin <username>'); break; }
          await adminSetAdmin(arg1.toLowerCase(), true);
          break;

        case '/removeadmin':
          if (!arg1) { await sendSystem('usage: /removeadmin <username>'); break; }
          await adminSetAdmin(arg1.toLowerCase(), false);
          break;

        case '/announce':
          if (!argRest) { await sendSystem('usage: /announce <message>'); break; }
          await adminAnnounce(argRest);
          break;

        case '/listadmins':
          await adminListAdmins();
          break;

        case '/whois':
          if (!arg1) { await sendSystem('usage: /whois <username>'); break; }
          await adminWhois(arg1.toLowerCase());
          break;

        case '/lockchat':
          await db.collection('settings').doc('chat').set({ locked: true }, { merge: true });
          await sendSystem(`chat locked by ${my.username}`);
          break;

        case '/unlockchat':
          await db.collection('settings').doc('chat').set({ locked: false }, { merge: true });
          await sendSystem(`chat unlocked by ${my.username}`);
          break;

        case '/slowmode':
          if (!arg1) { await sendSystem('usage: /slowmode <seconds> (0 to disable)'); break; }
          await db.collection('settings').doc('chat').set({ slowmode: parseInt(arg1, 10) }, { merge: true });
          await sendSystem(`slowmode set to ${arg1} sec by ${my.username}`);
          break;

        case '/topic':
          if (!argRest) { await sendSystem('usage: /topic <message>'); break; }
          await db.collection('settings').doc('chat').set({ topic: argRest }, { merge: true });
          await sendSystem(`chat topic updated: ${argRest}`);
          break;

        case '/shadowban':
          if (!arg1) { await sendSystem('usage: /shadowban <user>'); break; }
          await adminShadowban(arg1.toLowerCase());
          break;

        case '/unshadowban':
          if (!arg1) { await sendSystem('usage: /unshadowban <user>'); break; }
          await adminUnshadowban(arg1.toLowerCase());
          break;

        case '/purge':
          if (!arg1) { await sendSystem('usage: /purge <username> [count]'); break; }
          await adminPurge(arg1.toLowerCase(), parseInt(parts[2], 10) || 50);
          break;

        default:
          await sendSystem('unknown admin command. use /help to list commands.');
      }
    }

    // ---------- extra admin helpers ----------
    async function adminShadowban(username) {
      const u = await findUserByUsername(username);
      if (!u) { await sendSystem(`user ${username} not found`); return; }
      await db.collection('shadowbanned_users').doc(u.uid).set({ username:u.data.username, bannedBy:my.username });
      await sendSystem(`${u.data.username} shadowbanned by ${my.username}`);
    }
    async function adminUnshadowban(username) {
      const u = await findUserByUsername(username);
      if (!u) { await sendSystem(`user ${username} not found`); return; }
      await db.collection('shadowbanned_users').doc(u.uid).delete();
      await sendSystem(`${u.data.username} unshadowbanned by ${my.username}`);
    }

    async function adminPurge(username, count=50) {
      const snap = await db.collection('messages').where('username','==',username).orderBy('timestamp','desc').limit(count).get();
      const batch = db.batch();
      snap.docs.forEach(d => batch.delete(d.ref));
      await batch.commit();
      await sendSystem(`${my.username} purged ${snap.size} messages from ${username}`);
    }

    // ---------- locked chat + slowmode enforcement ----------
    let lastSentAt = 0;
    async function enforceRestrictions() {
      const doc = await db.collection('settings').doc('chat').get();
      if (!doc.exists) return { ok:true };
      const data = doc.data();

      if (data.locked && !my.isAdmin) {
        toast('chat is locked by admins');
        return { ok:false };
      }

      if (data.slowmode && data.slowmode > 0) {
        const now = Date.now();
        if (now - lastSentAt < data.slowmode * 1000) {
          toast(`slowmode: wait ${Math.ceil((data.slowmode*1000 - (now-lastSentAt))/1000)}s`);
          return { ok:false };
        }
        lastSentAt = now;
      }

      return { ok:true };
    }

    // hook into sendMessage
    const origSendMessage = sendMessage;
    sendMessage = async function() {
      const check = await enforceRestrictions();
      if (!check.ok) return;
      await origSendMessage();
    };
  </script>
</body>
</html>
