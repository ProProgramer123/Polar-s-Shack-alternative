<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Polar's Shack Admin</title>
  <link id="favicon" rel="icon" href="logo.png" type="image/png"/>
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'JetBrains Mono','Courier New',monospace;background:#1a1a1a;color:#888;min-height:100vh}
    .login-container{display:flex;justify-content:center;align-items:center;min-height:100vh;background:linear-gradient(135deg,#1a1a1a 0%,#2a2a2a 100%)}
    .login-box{background:#2a2a2a;border:1px solid #333;border-radius:8px;padding:3rem;max-width:400px;width:100%;text-align:center}
    .login-box h1{color:#fff;font-size:1.8rem;margin-bottom:.5rem}
    .login-box p{color:#666;margin-bottom:2rem;font-size:.9rem}
    .form-group{margin-bottom:1.5rem;text-align:left}
    .form-group label{display:block;color:#888;margin-bottom:.5rem;font-size:.9rem}
    .form-group input{width:100%;padding:1rem;background:#333;border:1px solid #444;border-radius:4px;color:#fff;font-size:.9rem;outline:none;transition:.3s;font-family:'JetBrains Mono',monospace}
    .form-group input:focus{border-color:#00ff00;box-shadow:0 0 10px rgba(0,255,0,.2)}
    .login-btn{width:100%;padding:1rem;background:#00ff00;color:#1a1a1a;border:none;border-radius:4px;font-size:.9rem;font-weight:600;cursor:pointer;transition:.3s;font-family:'JetBrains Mono',monospace}
    .login-btn:hover{background:#00cc00;transform:translateY(-1px)}
    .error-message{color:#ff6666;margin-top:1rem;font-size:.8rem;display:none}
    .logout-btn{position:fixed;top:2rem;right:2rem;background:#ff6666;color:#fff;border:none;padding:.8rem 1.2rem;border-radius:4px;cursor:pointer;font-size:.8rem;transition:.3s;font-family:'JetBrains Mono',monospace;z-index:1000}
    .logout-btn:hover{background:#ff4444;transform:translateY(-1px)}
    .admin-container{display:none;padding:2rem;max-width:1400px;margin:0 auto}
    .admin-header{background:#2a2a2a;border:1px solid #333;border-radius:8px;padding:2rem;margin-bottom:2rem;text-align:center}
    .admin-header h1{color:#fff;font-size:2rem;margin-bottom:.5rem}
    .admin-header p{color:#666;font-size:.9rem}
    .admin-nav{display:flex;gap:1rem;margin:1rem 0 2rem;flex-wrap:wrap;justify-content:center}
    .nav-btn{background:#333;color:#888;border:1px solid #444;padding:.8rem 1.5rem;border-radius:4px;cursor:pointer;font-family:'JetBrains Mono',monospace;font-size:.8rem;transition:.3s}
    .nav-btn.active{background:#00ff00;color:#1a1a1a;border-color:#00ff00}
    .nav-btn:hover{background:#444;color:#00ff00;border-color:#00ff00}
    .nav-btn.active:hover{background:#00cc00}
    .admin-section{display:none;background:#2a2a2a;border:1px solid #333;border-radius:8px;padding:2rem}
    .admin-section.active{display:block}
    .admin-section h2{color:#fff;font-size:1.3rem;margin-bottom:1.5rem;border-bottom:1px solid #333;padding-bottom:.5rem}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:2rem}
    .stat-card{background:#333;padding:1.5rem;border-radius:8px;border:1px solid #444;text-align:center}
    .stat-number{font-size:2rem;font-weight:700;color:#00ff00;margin-bottom:.5rem}
    .stat-label{color:#888;font-size:.8rem;text-transform:uppercase}
    .data-table{width:100%;border-collapse:collapse;margin-bottom:2rem;background:#333;border-radius:8px;overflow:hidden}
    .data-table th,.data-table td{padding:1rem;text-align:left;border-bottom:1px solid #444}
    .data-table th{background:#444;color:#fff;font-weight:600;font-size:.8rem;text-transform:uppercase}
    .data-table td{color:#888;font-size:.8rem}
    .data-table tr:hover{background:#3a3a3a}
    .action-btn{background:#444;color:#00ff00;border:1px solid #555;padding:.3rem .8rem;border-radius:3px;cursor:pointer;font-size:.7rem;margin-right:.5rem;transition:.3s;font-family:'JetBrains Mono',monospace}
    .action-btn:hover{background:#555;border-color:#00ff00}
    .action-btn.danger{color:#ff6666;border-color:#ff6666}
    .action-btn.danger:hover{background:#ff6666;color:#fff}
    .form-inline{display:flex;gap:1rem;align-items:end;margin-bottom:1.5rem;flex-wrap:wrap}
    .form-inline .form-group{margin-bottom:0;flex:1;min-width:200px}
    .form-inline button{background:#00ff00;color:#1a1a1a;border:none;padding:1rem 1.5rem;border-radius:4px;cursor:pointer;font-size:.8rem;font-weight:600;transition:.3s;font-family:'JetBrains Mono',monospace;white-space:nowrap}
    .form-inline button:hover{background:#00cc00;transform:translateY(-1px)}
    .form-inline button.danger{background:#ff6666;color:#fff}
    .form-inline button.danger:hover{background:#ff4444}
    .maintenance-toggle{background:#333;padding:1.5rem;border-radius:8px;border:1px solid #444;margin-bottom:2rem}
    .toggle-switch{position:relative;display:inline-block;width:60px;height:34px;margin-right:1rem}
    .toggle-switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#444;transition:.4s;border-radius:34px}
    .slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background:#888;transition:.4s;border-radius:50%}
    input:checked + .slider{background:#ff6666}
    input:checked + .slider:before{transform:translateX(26px);background:#fff}
    .system-controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;margin-bottom:2rem}
    .control-card{background:#333;padding:1.5rem;border-radius:8px;border:1px solid #444}
    .control-card h4{color:#fff;margin-bottom:1rem;font-size:1rem}
    .control-card p{color:#666;font-size:.8rem;margin-bottom:1rem}
    .status-badge{display:inline-block;padding:.2rem .6rem;border-radius:12px;font-size:.7rem;font-weight:600;text-transform:uppercase}
    .status-badge.online{background:rgba(0,255,0,.2);color:#00ff00;border:1px solid #00ff00}
    .status-badge.offline{background:rgba(255,102,102,.2);color:#ff6666;border:1px solid #ff6666}
    .status-badge.maintenance{background:rgba(255,165,0,.2);color:#ffa500;border:1px solid #ffa500}
    .real-time-indicator{position:fixed;top:2rem;left:2rem;background:#333;padding:.5rem 1rem;border-radius:4px;border:1px solid #444;font-size:.7rem;z-index:1000}
    .real-time-indicator.connected{border-color:#00ff00;color:#00ff00}
    .real-time-indicator.disconnected{border-color:#ff6666;color:#ff6666}
    @media (max-width:768px){
      .admin-container{padding:1rem}
      .admin-header{padding:1.5rem}
      .stats-grid{grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}
      .form-inline{flex-direction:column;align-items:stretch}
      .form-inline .form-group{min-width:unset}
      .logout-btn{top:1rem;right:1rem;padding:.6rem 1rem}
      .real-time-indicator{top:1rem;left:1rem}
    }
  </style>
</head>
<body>
  <!-- live connection indicator -->
  <div class="real-time-indicator" id="connectionStatus"><i class='bx bx-wifi'></i> connectingâ€¦</div>

  <!-- login -->
  <div class="login-container" id="loginContainer">
    <div class="login-box">
      <h1>admin access</h1>
      <p>enter credentials to access the administration panel</p>
      <form id="loginForm">
        <div class="form-group">
          <label for="password">password</label>
          <input type="password" id="password" placeholder="enter admin password" required/>
        </div>
        <button type="submit" class="login-btn"><i class='bx bx-log-in'></i> authenticate</button>
        <div class="error-message" id="errorMessage"></div>
      </form>
    </div>
  </div>

  <!-- admin -->
  <div class="admin-container" id="adminPanel">
    <button class="logout-btn" onclick="logout()"><i class='bx bx-log-out'></i> logout</button>

    <div class="admin-header">
      <h1>polar's shack admin</h1>
      <p>comprehensive system administration and monitoring dashboard</p>
    </div>

    <nav class="admin-nav">
      <button class="nav-btn active" onclick="showSection('dashboard')">dashboard</button>
      <button class="nav-btn" onclick="showSection('users')">users</button>
      <button class="nav-btn" onclick="showSection('reports')">reports</button>
      <button class="nav-btn" onclick="showSection('chat')">chat logs</button>
      <button class="nav-btn" onclick="showSection('system')">system</button>
      <button class="nav-btn" onclick="showSection('maintenance')">maintenance</button>
      <button class="nav-btn" onclick="showSection('security')">security</button>
    </nav>

    <!-- Dashboard -->
    <section class="admin-section active" id="dashboard">
      <h2>system overview</h2>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-number" id="totalUsers">0</div><div class="stat-label">total users</div></div>
        <div class="stat-card"><div class="stat-number" id="onlineUsers">0</div><div class="stat-label">online users</div></div>
        <div class="stat-card"><div class="stat-number" id="totalReports">0</div><div class="stat-label">total reports</div></div>
        <div class="stat-card"><div class="stat-number" id="pendingReports">0</div><div class="stat-label">pending reports</div></div>
        <div class="stat-card"><div class="stat-number" id="proxyRequests">0</div><div class="stat-label">proxy requests</div></div>
        <div class="stat-card"><div class="stat-number" id="systemUptime">0h</div><div class="stat-label">system uptime</div></div>
      </div>

      <div class="system-controls">
        <div class="control-card">
          <h4>proxy service</h4>
          <p>custom proxy server status</p>
          <span class="status-badge" id="proxyStatus">unknown</span>
        </div>
        <div class="control-card">
          <h4>chat system</h4>
          <p>real-time chat functionality</p>
          <span class="status-badge online" id="chatStatus">online</span>
        </div>
        <div class="control-card">
          <h4>database</h4>
          <p>firebase connection</p>
          <span class="status-badge online" id="dbStatus">online</span>
        </div>
        <div class="control-card">
          <h4>site status</h4>
          <p>overall website availability</p>
          <span class="status-badge online" id="siteStatus">online</span>
        </div>
      </div>
    </section>

    <!-- Users -->
    <section class="admin-section" id="users">
      <h2>user management</h2>
      <table class="data-table">
        <thead><tr><th>device id</th><th>first seen</th><th>last seen</th><th>last page</th></tr></thead>
        <tbody id="usersTable"></tbody>
      </table>
    </section>

    <!-- Reports -->
    <section class="admin-section" id="reports">
      <h2>game reports</h2>
      <table class="data-table">
        <thead><tr><th>game</th><th>reason</th><th>description</th><th>reported</th><th>status</th></tr></thead>
        <tbody id="reportsTable"></tbody>
      </table>
    </section>

    <!-- Chat (placeholder hooks to your chat admin) -->
    <section class="admin-section" id="chat">
      <h2>chat management</h2>
      <div class="form-inline">
        <div class="form-group"><label for="banUsername">ban user:</label><input type="text" id="banUsername" placeholder="enter username"/></div>
        <button onclick="banUser()">ban user</button>
      </div>
      <div class="form-inline">
        <div class="form-group"><label for="unbanUsername">unban user:</label><input type="text" id="unbanUsername" placeholder="enter username"/></div>
        <button onclick="unbanUser()">unban user</button>
      </div>
      <h3 style="color:#fff;margin:2rem 0 1rem;">recent chat messages</h3>
      <div id="chatLogs"></div>
    </section>

    <!-- System -->
    <section class="admin-section" id="system">
      <h2>system management</h2>
      <div class="form-inline">
        <button onclick="exportData()">export data</button>
      </div>
      <h3 style="color:#fff;margin:2rem 0 1rem;">system logs</h3>
      <div id="systemLogs"></div>
    </section>

    <!-- Maintenance -->
    <section class="admin-section" id="maintenance">
      <h2>maintenance mode</h2>

      <div class="maintenance-toggle">
        <h3>site maintenance</h3>
        <label class="toggle-switch">
          <input type="checkbox" id="maintenanceToggle" onchange="toggleMaintenance()"/>
          <span class="slider"></span>
        </label>
        <span id="maintenanceStatus">maintenance mode disabled</span>
        <p style="color:#666;margin-top:1rem;font-size:.8rem;">when enabled, visitors will see a maintenance popup with update information across ALL devices</p>
      </div>

      <div class="form-inline">
        <div class="form-group">
          <label for="maintenanceMessage">custom maintenance message</label>
          <input type="text" id="maintenanceMessage" placeholder="enter custom message for users" value="Polar's Shack is currently receiving a new update, and we're trying to push it to your device. This is marked as a beta update, so if anything is broken, please report the game or issue thru the play page when you select a game or app, or directly from the games / apps page. Thank you."/>
        </div>
        <button onclick="updateMaintenanceMessage()">update message</button>
      </div>

      <div class="form-inline">
        <button onclick="enableGlobalMaintenance()">enable global maintenance</button>
        <button onclick="disableGlobalMaintenance()">disable global maintenance</button>
        <button class="danger" onclick="emergencyGlobalLockdown()">global emergency lockdown</button>
      </div>

      <div class="maintenance-toggle">
        <h3>allow maintenance dismissal during lockdown</h3>
        <label class="toggle-switch">
          <input type="checkbox" id="allowDismissalToggle" onchange="toggleMaintenanceDismissal()"/>
          <span class="slider"></span>
        </label>
        <span id="dismissalStatus">dismissal disabled during lockdown</span>
      </div>
    </section>

    <!-- Security (local UI only) -->
    <section class="admin-section" id="security">
      <h2>security management</h2>
      <div class="form-inline">
        <div class="maintenance-toggle">
          <h3>security system</h3>
          <label class="toggle-switch">
            <input type="checkbox" id="securityToggle" onchange="toggleSecuritySystem()" checked/>
            <span class="slider"></span>
          </label>
          <span id="securityStatus">security system enabled</span>
        </div>
      </div>

      <div class="system-controls">
        <div class="control-card"><h4>failed login attempts</h4><p>monitor unauthorized access attempts</p><div class="stat-number" style="font-size:1.5rem" id="failedLogins">0</div></div>
        <div class="control-card"><h4>active sessions</h4><p>current admin sessions</p><div class="stat-number" style="font-size:1.5rem" id="activeSessions">1</div></div>
        <div class="control-card"><h4>proxy blocks</h4><p>blocked malicious requests</p><div class="stat-number" style="font-size:1.5rem" id="proxyBlocks">0</div></div>
        <div class="control-card"><h4>rate limits</h4><p>requests per minute limit</p><div class="stat-number" style="font-size:1.5rem" id="rateLimit">100</div></div>
      </div>
    </section>
  </div>

  <!-- Firebase init (ONE time) -->
  <script>
    // Replace with your config if different
    const firebaseConfig = {
      apiKey: "AIzaSyBYyJuTAkVPB_65NqSeca6IueMoMO1iPzs",
      authDomain: "polars-shack.firebaseapp.com",
      projectId: "polars-shack",
      storageBucket: "polars-shack.firebasestorage.app",
      messagingSenderId: "205388124682",
      appId: "1:205388124682:web:2b0b1605517e0c6c53c5f3",
      databaseURL: "https://polars-shack-default-rtdb.firebaseio.com"   // RTDB
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db   = firebase.firestore();     // game_reports live here
    const rtdb = firebase.database();      // users/online/stats/maintenance live here

    auth.onAuthStateChanged(async u => {
      if (!u) { try { await auth.signInAnonymously(); } catch(e){ console.log('anon auth failed', e); } }
    });
  </script>

  <!-- Global maintenance popup listener (works on ALL pages) -->
  <script>
    (function maintenanceListener(){
      if (!window.firebase?.database) return;
      const ref = firebase.database().ref('settings/maintenance');
      let box;
      function ensureBox(){
        if (box) return box;
        box = document.createElement('div');
        box.id = 'ps-maintenance';
        box.style.cssText = 'position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.85);z-index:999999;';
        box.innerHTML = `
          <div style="background:#2a2a2a;border:1px solid #444;border-radius:10px;max-width:620px;width:92%;padding:1.25rem;font-family:JetBrains Mono,monospace;color:#ddd;text-align:center">
            <h2 style="color:#fff;margin:0 0 .5rem">Maintenance</h2>
            <p id="ps-maint-msg" style="margin:.5rem 0 1rem;color:#bbb"></p>
            <button id="ps-maint-dismiss" style="display:none;background:#333;color:#0f0;border:1px solid #444;padding:.6rem 1rem;border-radius:6px;cursor:pointer">dismiss</button>
          </div>`;
        document.body.appendChild(box);
        box.querySelector('#ps-maint-dismiss').addEventListener('click', ()=>{ box.style.display='none'; });
        return box;
      }
      ref.on('value', snap => {
        const s = snap.val() || {};
        const active = !!(s.lockdownMode || s.maintenanceMode);
        const dismissible = !!s.allowDismissal && !s.lockdownMode;
        const msg = s.maintenanceMessage || 'We are performing maintenance. Please check back soon.';
        const el = ensureBox();
        el.querySelector('#ps-maint-msg').textContent = msg;
        el.querySelector('#ps-maint-dismiss').style.display = dismissible ? '' : 'none';
        el.style.display = active ? 'flex' : 'none';
      });
    })();
  </script>

  <!-- Admin logic -->
  <script>
    class AdminPanel {
      constructor(){
        this.startTime = Date.now();
        this.proxyServerUrl = 'https://render-proxy-6x2v.onrender.com'; // optional, best-effort check
        this.securityData = {
          failedLogins: parseInt(localStorage.getItem('failedLogins') || '0', 10),
          proxyBlocks:  parseInt(localStorage.getItem('proxyBlocks')  || '0', 10),
          rateLimit:    parseInt(localStorage.getItem('rateLimit')    || '100',10),
          activeSessions: 1,
          securityLogs: JSON.parse(localStorage.getItem('securityLogs')||'[]')
        };
        this.rtdb = rtdb;
        this.db   = db;
        this.maintenanceRef = rtdb.ref('settings/maintenance');
        // local password gate (extra barrier)
        this.adminPasswordHash = '50172b3e278ccc1f2caaac89e2911df21304024b98578c4642af9d340fc73b71'; // Mango030911!
        this.isLoggedIn = false;
      }

      init(){
        this.setupEventListeners();
        this.checkLoginStatus();
        this.updateConnectionStatus();
        this.initializeProxyCheck();
        this.loadSecurityData();

        // Live RTDB wires
        this.wireRealtimeStats();
        this.subscribeMaintenance();

        // Firestore (reports)
        this.loadFirebaseData();

        // anon auth ensures RTDB perms; UI shows connected regardless
      }

      setupEventListeners(){
        document.querySelectorAll('.nav-btn').forEach(btn=>{
          btn.addEventListener('click',e=>{
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            e.target.classList.add('active');
          });
        });
      }

      updateConnectionStatus(){
        const el = document.getElementById('connectionStatus');
        el.className = 'real-time-indicator connected';
        el.innerHTML = "<i class='bx bx-wifi'></i> Connected (Firebase)";
      }

      async initializeProxyCheck(){
        const el = document.getElementById('proxyStatus');
        try {
          // Render blocks CORS; do best-effort ping
          await fetch(this.proxyServerUrl + '/health', { mode:'no-cors' });
          if (el){ el.className = 'status-badge online'; el.textContent = 'online'; }
        } catch {
          if (el){ el.className = 'status-badge offline'; el.textContent = 'offline'; }
        }
      }

      loadSecurityData(){
        this.updateSecurityStats();
      }
      updateSecurityStats(){
        document.getElementById('failedLogins').textContent  = this.securityData.failedLogins;
        document.getElementById('activeSessions').textContent= this.securityData.activeSessions;
        document.getElementById('proxyBlocks').textContent   = this.securityData.proxyBlocks;
        document.getElementById('rateLimit').textContent     = this.securityData.rateLimit;
      }

      // ---------- AUTH WALL ----------
      async hashPassword(password){
        const enc = new TextEncoder().encode(password);
        const hash = await crypto.subtle.digest('SHA-256', enc);
        return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
      }
      async handleLogin(e){
        e.preventDefault();
        const pwd = document.getElementById('password').value;
        const err = document.getElementById('errorMessage');
        try{
          const h = await this.hashPassword(pwd);
          if (h === this.adminPasswordHash){
            this.isLoggedIn = true;
            localStorage.setItem('adminLoggedIn','true');
            localStorage.setItem('loginTime', Date.now().toString());
            document.getElementById('loginContainer').style.display='none';
            document.getElementById('adminPanel').style.display='block';
            this.addSecurityLog('Admin login successful','info');
          } else {
            this.securityData.failedLogins++;
            localStorage.setItem('failedLogins', String(this.securityData.failedLogins));
            this.updateSecurityStats();
            err.textContent = 'Invalid password. Please try again.'; err.style.display='block';
          }
        } catch (e){ err.textContent='Login failed. Try again.'; err.style.display='block'; }
      }
      checkLoginStatus(){
        const ok = localStorage.getItem('adminLoggedIn')==='true';
        const t  = parseInt(localStorage.getItem('loginTime') || '0', 10);
        if (ok && Date.now() - t < 24*60*60*1000){
          this.isLoggedIn = true;
          document.getElementById('loginContainer').style.display='none';
          document.getElementById('adminPanel').style.display='block';
        } else {
          this.logout(true);
        }
      }
      logout(onlyShow=false){
        this.isLoggedIn = false;
        localStorage.removeItem('adminLoggedIn'); localStorage.removeItem('loginTime');
        if (!onlyShow) this.addSecurityLog('Admin logged out','info');
        document.getElementById('adminPanel').style.display='none';
        document.getElementById('loginContainer').style.display='block';
      }

      // ---------- UI ----------
      showSection(id){
        document.querySelectorAll('.admin-section').forEach(s=>s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
      }
      updateUptime(){
        const el = document.getElementById('systemUptime');
        const h = Math.floor((Date.now() - this.startTime)/ (1000*60*60));
        el.textContent = h + 'h';
      }

      // ---------- RTDB live stats ----------
      wireRealtimeStats(){
        // total users (unique devices)
        this.rtdb.ref('users').on('value', snap=>{
          document.getElementById('totalUsers').textContent = String(snap.numChildren()||0);
          // also render simple table (first 100)
          const body = document.getElementById('usersTable');
          body.innerHTML = '';
          let i = 0;
          snap.forEach(child=>{
            if (i++ > 100) return;
            const u = child.val() || {};
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${child.key}</td>
              <td>${u.firstSeen ? new Date(u.firstSeen).toLocaleString() : '-'}</td>
              <td>${u.lastSeen ? new Date(u.lastSeen).toLocaleString() : '-'}</td>
              <td>${u.lastPage || '-'}</td>`;
            body.appendChild(tr);
          });
        });

        // online users (sessions)
        this.rtdb.ref('onlineUsers').on('value', snap=>{
          document.getElementById('onlineUsers').textContent = String(snap.numChildren()||0);
        });

        // proxy requests counter (optional)
        this.rtdb.ref('stats/proxyRequests').on('value', snap=>{
          document.getElementById('proxyRequests').textContent = String(snap.val()||0);
        });

        // uptime ticker
        setInterval(()=>this.updateUptime(), 60000);
        this.updateUptime();
      }

      // ---------- Firestore reports ----------
      async loadFirebaseData(){
        try{
          const qs = await this.db.collection('game_reports').orderBy('timestamp','desc').limit(100).get();
          const rows = [];
          qs.forEach(d=>{
            const r = d.data() || {};
            rows.push({
              id:d.id,
              type:r.reason || r.type || 'report',
              reason:r.reason || '-',
              description:r.description || '',
              status:r.status || 'pending',
              timestamp:r.timestamp?.toDate?.() || (r.timestamp || Date.now()),
              gameName:r.gameName || r.game || '-'
            });
          });

          document.getElementById('totalReports').textContent   = String(rows.length);
          document.getElementById('pendingReports').textContent = String(rows.filter(x=>x.status==='pending').length);

          const body = document.getElementById('reportsTable');
          body.innerHTML = '';
          rows.forEach(r=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${r.gameName}</td>
              <td>${r.reason}</td>
              <td>${r.description}</td>
              <td>${new Date(r.timestamp).toLocaleString()}</td>
              <td>${r.status}</td>`;
            body.appendChild(tr);
          });
        } catch (e){ console.log('[admin] loadFirebaseData', e); }
      }

      // ---------- Maintenance (RTDB) ----------
      subscribeMaintenance(){
        this.maintenanceRef.on('value', snap=>{
          const s = snap.val() || {};
          localStorage.setItem('maintenanceMode', s.maintenanceMode ? 'true' : 'false');
          localStorage.setItem('lockdownMode',     s.lockdownMode   ? 'true' : 'false');
          if (typeof s.maintenanceMessage === 'string') {
            localStorage.setItem('maintenanceMessage', s.maintenanceMessage);
          }
          const toggle = document.getElementById('maintenanceToggle');
          const status = document.getElementById('maintenanceStatus');
          const site   = document.getElementById('siteStatus');
          toggle.checked = !!(s.maintenanceMode || s.lockdownMode);
          if (s.lockdownMode){ status.textContent='emergency lockdown active'; status.style.color='#ff6666'; site.className='status-badge offline'; site.textContent='lockdown'; }
          else if (s.maintenanceMode){ status.textContent='maintenance mode enabled'; status.style.color='#ffa500'; site.className='status-badge maintenance'; site.textContent='maintenance'; }
          else { status.textContent='maintenance mode disabled'; status.style.color='#888'; site.className='status-badge online'; site.textContent='online'; }
          const allow = !!s.allowDismissal && !s.lockdownMode;
          document.getElementById('allowDismissalToggle').checked = allow;
          document.getElementById('dismissalStatus').textContent = allow ? 'dismissal allowed during lockdown' : 'dismissal disabled during lockdown';
          document.getElementById('dismissalStatus').style.color = allow ? '#00ff00' : '#ff6666';
          if (typeof s.maintenanceMessage === 'string'){
            const msg = document.getElementById('maintenanceMessage');
            if (msg && msg !== document.activeElement) msg.value = s.maintenanceMessage;
          }
        });
      }
      async updateServerMaintenanceState(state){
        // Requires RTDB rule: roles/<uid>/isAdmin == true
        const uid = (firebase.auth().currentUser && firebase.auth().currentUser.uid) || 'unknown';
        return this.maintenanceRef.update({
          ...state,
          updatedBy: uid,
          updatedAt: firebase.database.ServerValue.TIMESTAMP
        });
      }
      async enableGlobalMaintenance(){
        const message = document.getElementById('maintenanceMessage').value || "Polar's Shack is currently receiving a new update...";
        try{
          await this.updateServerMaintenanceState({ maintenanceMode:true, lockdownMode:false, allowDismissal:true, maintenanceMessage: message });
          alert('Global maintenance enabled');
        }catch(e){ alert('Failed: missing RTDB admin role for this UID. Create roles/<uid>/isAdmin=true.'); }
      }
      async disableGlobalMaintenance(){
        try{
          await this.updateServerMaintenanceState({ maintenanceMode:false, lockdownMode:false, maintenanceMessage:'' });
          alert('Global maintenance disabled');
        }catch(e){ alert('Failed: missing RTDB admin role for this UID.'); }
      }
      async emergencyGlobalLockdown(){
        if (!confirm('Activate GLOBAL EMERGENCY LOCKDOWN?')) return;
        try{
          await this.updateServerMaintenanceState({
            maintenanceMode:false, lockdownMode:true, allowDismissal:false,
            maintenanceMessage:'EMERGENCY LOCKDOWN: This site is temporarily unavailable due to security concerns.'
          });
          alert('GLOBAL EMERGENCY LOCKDOWN ACTIVATED!');
        }catch(e){ alert('Failed: missing RTDB admin role for this UID.'); }
      }
      async toggleMaintenance(){
        // local toggle just mirrors current RTDB flags quickly
        const checked = document.getElementById('maintenanceToggle').checked;
        if (checked) return this.enableGlobalMaintenance();
        return this.disableGlobalMaintenance();
      }
      async updateMaintenanceMessage(){
        const message = (document.getElementById('maintenanceMessage').value || '').trim();
        if (!message) return alert('Please enter a maintenance message');
        try{
          await this.updateServerMaintenanceState({ maintenanceMessage: message });
          alert('Maintenance message updated');
        }catch(e){ alert('Failed: missing RTDB admin role for this UID.'); }
      }
      toggleMaintenanceDismissal(){
        const allow = document.getElementById('allowDismissalToggle').checked;
        this.updateServerMaintenanceState({ allowDismissal: !!allow }).catch(()=>alert('Failed: missing RTDB admin role for this UID.'));
      }

      // ---------- Misc/UI helpers ----------
      addSecurityLog(message, level='info'){
        const entry = { ts: Date.now(), level, message };
        this.securityData.securityLogs.unshift(entry);
        if (this.securityData.securityLogs.length>100) this.securityData.securityLogs.pop();
        localStorage.setItem('securityLogs', JSON.stringify(this.securityData.securityLogs));
      }
      // stubs
      banUser(){ alert('hook up to your chat admin logic'); }
      unbanUser(){ alert('hook up to your chat admin logic'); }
      exportData(){ alert('implement as needed'); }
      toggleSecuritySystem(){
        const on = document.getElementById('securityToggle').checked;
        const s = document.getElementById('securityStatus');
        s.textContent = on ? 'security system enabled' : 'security system disabled';
        s.style.color = on ? '#4CAF50' : '#ff6666';
      }
    }

    // Create panel ONCE and wire globals
    const adminPanel = new AdminPanel();

    // login submit
    document.getElementById('loginForm').addEventListener('submit', (e)=>adminPanel.handleLogin(e));

    // wire functions for onclick HTML
    window.showSection               = (id)=>adminPanel.showSection(id);
    window.logout                    = ()=>adminPanel.logout();
    window.toggleMaintenance         = ()=>adminPanel.toggleMaintenance();
    window.updateMaintenanceMessage  = ()=>adminPanel.updateMaintenanceMessage();
    window.enableGlobalMaintenance   = ()=>adminPanel.enableGlobalMaintenance();
    window.disableGlobalMaintenance  = ()=>adminPanel.disableGlobalMaintenance();
    window.emergencyGlobalLockdown   = ()=>adminPanel.emergencyGlobalLockdown();
    window.toggleMaintenanceDismissal= ()=>adminPanel.toggleMaintenanceDismissal();
    window.toggleSecuritySystem      = ()=>adminPanel.toggleSecuritySystem();
    window.banUser                   = ()=>adminPanel.banUser();
    window.unbanUser                 = ()=>adminPanel.unbanUser();
    window.exportData                = ()=>adminPanel.exportData();

    // boot
    adminPanel.init();

    // tab title flair
    document.addEventListener('visibilitychange', ()=>{
      if (document.hidden){
        document.title = "Dashboard";
        document.getElementById("favicon").href = "https://s3.amazonaws.com/cdn.app.cte.virginia.edu/tools/images/XmeGg2PHFfRHaj3upWvncc2gmaG91fApdtDC8bdU.png";
      } else {
        document.title = "Polar's Shack - Admin";
        document.getElementById("favicon").href = "logo.png";
      }
    });
  </script>

  <!-- Presence & counters (OPTIONAL on admin page, REQUIRED on user pages) -->
  <script src="analytics.js"></script>
  <script> if (window.initAnalytics) initAnalytics('/admin.html'); </script>
</body>
</html>
